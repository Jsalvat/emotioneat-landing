---
import BlogLayout from '../../layouts/BlogLayout.astro';
import { supabase } from '../../lib/supabase';

// Fetch blog posts (English only)
let posts: any[] = [];
try {
	if (supabase) {
		const { data, error } = await supabase
			.from('blog_posts')
			.select(`
				id,
				slug,
				published_at,
				reading_time,
				cover_image_url,
				title_en,
				excerpt_en
			`)
			.eq('status', 'published')
			.order('published_at', { ascending: false });

		if (error) {
			console.error('Error fetching blog posts:', error);
		} else {
			posts = (data || []).map((post: any) => ({
				...post,
				title: post.title_en || '',
				excerpt: post.excerpt_en || ''
			}));
		}
	} else {
		console.warn('Supabase not configured - showing empty blog');
	}
} catch (error) {
	console.error('Error connecting to Supabase:', error);
}

// SEO Meta
const title = 'Blog | EmotionEat - Emotional Eating Tips & Advice';
const description = 'Discover expert tips on emotional eating, strategies to control binge eating, and improve your relationship with food.';
---

<BlogLayout
	title={title}
	description={description}
>
	<!-- Hero Section -->
	<section class="bg-gradient-to-br from-primary-50 to-secondary-50 py-20">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="text-center">
				<h1 class="text-4xl md:text-6xl font-bold text-neutral-900 mb-6">
					Emotional Eating Blog
				</h1>
				<p class="text-xl text-neutral-600 max-w-3xl mx-auto leading-relaxed">
					Expert tips, practical strategies, and professional support to overcome emotional eating and create a healthy relationship with food.
				</p>
			</div>
		</div>
	</section>

	<!-- Blog Posts Grid -->
	<section class="py-16 bg-white">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			{posts && posts.length > 0 ? (
				<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
					{posts.map((post) => (
						<article class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300 border border-neutral-100">
							{post.cover_image_url && (
								<div class="aspect-video overflow-hidden">
									<img
										src={post.cover_image_url}
										alt={post.title}
										class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
										loading="lazy"
									/>
								</div>
							)}
							<div class="p-6">
								<div class="flex items-center text-sm text-neutral-500 mb-3">
									<time datetime={post.published_at}>
										{new Date(post.published_at).toLocaleDateString('en-US', {
											year: 'numeric',
											month: 'long',
											day: 'numeric'
										})}
									</time>
									{post.reading_time && (
										<>
											<span class="mx-2">‚Ä¢</span>
											<span>{post.reading_time} min read</span>
										</>
									)}
								</div>

								<h2 class="text-xl font-bold text-neutral-900 mb-3 line-clamp-2">
									<a
										href={`/blog/${post.slug}`}
										class="hover:text-primary-400 transition-colors"
									>
										{post.title}
									</a>
								</h2>

								{post.excerpt && (
									<p class="text-neutral-600 line-clamp-3 mb-4">
										{post.excerpt}
									</p>
								)}

								<a
									href={`/blog/${post.slug}`}
									class="inline-flex items-center text-primary-400 font-medium hover:text-primary-500 transition-colors"
								>
									Read more
									<svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
									</svg>
								</a>
							</div>
						</article>
					))}
				</div>
			) : (
				<div class="text-center py-16">
					<div class="text-6xl mb-4">üìù</div>
					<h3 class="text-2xl font-bold text-neutral-900 mb-4">
						Coming Soon
					</h3>
					<p class="text-neutral-600 max-w-md mx-auto">
						We're working on amazing content about emotional eating. Check back soon!
					</p>
				</div>
			)}
		</div>
	</section>

	<!-- CTA Section -->
	<section class="bg-gradient-to-r from-primary-400 to-secondary-400 py-16">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
			<h2 class="text-3xl font-bold text-white mb-4">
				Ready to Change Your Relationship with Food?
			</h2>
			<p class="text-xl text-primary-50 mb-8">
				Start understanding your eating habits today, one conversation at a time.
			</p>
			<a
				href={import.meta.env.PUBLIC_APP_URL || 'https://app.emotioneat.com'}
				class="inline-flex items-center px-8 py-4 bg-white text-primary-500 font-semibold rounded-lg hover:bg-neutral-50 transition-colors shadow-lg"
			>
				Get Started
				<svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
				</svg>
			</a>
		</div>
	</section>
</BlogLayout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
