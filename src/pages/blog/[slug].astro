---
import BlogLayout from '../../layouts/BlogLayout.astro';
import { supabase } from '../../lib/supabase';
import en from '../../i18n/en.json';
import es from '../../i18n/es.json';

export const prerender = false;

// Detect language from URL
const lang = Astro.url.pathname.startsWith('/es') ? 'es' : 'en';
const t = lang === 'es' ? es : en;

// Get slug from URL
const { slug } = Astro.params;

// Fetch the blog post
let post = null;
let relatedPosts = null;

if (supabase && slug) {
	try {
		// Get the specific post
		const { data: postData, error: postError } = await supabase
			.from('blog_posts')
			.select('*')
			.eq('slug', slug)
			.eq('status', 'published')
			.single();

		if (postError) {
			console.error('Error fetching blog post:', postError);
		} else {
			post = postData;
		}

		// Get related posts if we have the current post
		if (post) {
			const { data: relatedPostsData } = await supabase
				.from('blog_posts')
				.select('title, slug, excerpt, cover_image_url, published_at')
				.eq('status', 'published')
				.neq('id', post.id)
				.order('published_at', { ascending: false })
				.limit(3);

			relatedPosts = relatedPostsData;
		}
	} catch (error) {
		console.error('Error connecting to Supabase:', error);
	}
}

// Handle 404 if post not found
if (!post) {
	return Astro.redirect(lang === 'es' ? '/es/blog' : '/blog');
}

// SEO Meta
const title = post.meta_title || `${post.title} | EmotionEat Blog`;
const description = post.meta_description || post.excerpt || post.title;
const image = post.cover_image_url || '/og-image.jpg';

// Calculate reading time if not set
const readingTime = post.reading_time || Math.ceil(post.content.split(' ').length / 200);
---

<BlogLayout
	title={title}
	description={description}
	image={image}
	lang={lang}
	published_at={post.published_at}
	updated_at={post.updated_at}
>
	<!-- Article Header -->
	<section class="bg-white py-16">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="text-center mb-8">
				<div class="flex items-center justify-center text-sm text-gray-500 mb-4">
					<time datetime={post.published_at}>
						{new Date(post.published_at).toLocaleDateString(lang === 'es' ? 'es-ES' : 'en-US', {
							year: 'numeric',
							month: 'long',
							day: 'numeric'
						})}
					</time>
					<span class="mx-2">•</span>
					<span>{readingTime} min read</span>
				</div>

				<h1 class="text-3xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
					{post.title}
				</h1>

				{post.excerpt && (
					<p class="text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
						{post.excerpt}
					</p>
				)}
			</div>

			{post.cover_image_url && (
				<div class="aspect-video rounded-xl overflow-hidden mb-8 shadow-lg">
					<img
						src={post.cover_image_url}
						alt={post.title}
						class="w-full h-full object-cover"
					/>
				</div>
			)}
		</div>
	</section>

	<!-- Article Content -->
	<article class="bg-white">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<div class="prose prose-lg max-w-none">
				<Fragment set:html={post.content} />
			</div>
		</div>
	</article>

	<!-- Author & Share Section -->
	<section class="bg-gray-50 py-12">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex flex-col md:flex-row items-center justify-between">
				<div class="flex items-center mb-6 md:mb-0">
					<div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-lg mr-4">
						E
					</div>
					<div>
						<p class="font-semibold text-gray-900">{post.author || (lang === 'es' ? 'Equipo EmotionEat' : 'EmotionEat Team')}</p>
						<p class="text-gray-600 text-sm">
							{lang === 'es' ? 'Expertos en Alimentación Emocional' : 'Emotional Eating Experts'}
						</p>
					</div>
				</div>

				<div class="flex items-center space-x-4">
					<span class="text-gray-600 text-sm">
						{lang === 'es' ? 'Compartir:' : 'Share:'}
					</span>
					<a
						href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.href)}`}
						target="_blank"
						rel="noopener noreferrer"
						class="text-gray-400 hover:text-blue-500 transition-colors"
						aria-label={lang === 'es' ? 'Compartir en Twitter' : 'Share on Twitter'}
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
							<path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
						</svg>
					</a>
					<a
						href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`}
						target="_blank"
						rel="noopener noreferrer"
						class="text-gray-400 hover:text-blue-600 transition-colors"
						aria-label={lang === 'es' ? 'Compartir en Facebook' : 'Share on Facebook'}
					>
						<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
							<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
						</svg>
					</a>
				</div>
			</div>
		</div>
	</section>

	<!-- Related Posts -->
	{relatedPosts && relatedPosts.length > 0 && (
		<section class="bg-white py-16">
			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
				<h2 class="text-3xl font-bold text-gray-900 text-center mb-12">
					{lang === 'es' ? 'Artículos Relacionados' : 'Related Articles'}
				</h2>

				<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
					{relatedPosts.map((relatedPost) => (
						<article class="bg-gray-50 rounded-lg overflow-hidden hover:shadow-md transition-shadow duration-300">
							{relatedPost.cover_image_url && (
								<div class="aspect-video overflow-hidden">
									<img
										src={relatedPost.cover_image_url}
										alt={relatedPost.title}
										class="w-full h-full object-cover"
										loading="lazy"
									/>
								</div>
							)}
							<div class="p-6">
								<h3 class="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
									<a
										href={`${lang === 'es' ? '/es' : ''}/blog/${relatedPost.slug}`}
										class="hover:text-blue-600 transition-colors"
									>
										{relatedPost.title}
									</a>
								</h3>
								<p class="text-gray-600 text-sm line-clamp-2">
									{relatedPost.excerpt}
								</p>
							</div>
						</article>
					))}
				</div>
			</div>
		</section>
	)}

	<!-- CTA Section -->
	<section class="bg-gradient-to-r from-blue-600 to-indigo-700 py-16">
		<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
			<h2 class="text-3xl font-bold text-white mb-4">
				{lang === 'es' ? '¿Quieres Ayuda Profesional?' : 'Need Professional Help?'}
			</h2>
			<p class="text-xl text-blue-100 mb-8">
				{lang === 'es'
					? 'Descubre cómo EmotionEat puede ayudarte a crear hábitos saludables y superar la alimentación emocional.'
					: 'Discover how EmotionEat can help you create healthy habits and overcome emotional eating.'
				}
			</p>
			<div class="flex flex-col sm:flex-row gap-4 justify-center">
				<a
					href={`${lang === 'es' ? '/es' : ''}#pricing`}
					class="inline-flex items-center px-8 py-4 bg-white text-blue-600 font-semibold rounded-lg hover:bg-gray-50 transition-colors shadow-lg"
				>
					{lang === 'es' ? 'Ver Planes' : 'View Plans'}
				</a>
				<a
					href={`${lang === 'es' ? '/es' : '/'}`}
					class="inline-flex items-center px-8 py-4 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-blue-600 transition-colors"
				>
					{lang === 'es' ? 'Saber Más' : 'Learn More'}
				</a>
			</div>
		</div>
	</section>
</BlogLayout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>